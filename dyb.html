<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yardage Book ‚Äì Cheadle GC</title>

<link rel="icon" href="skratch.png" type="image/png">
<link rel="apple-touch-icon" href="skratch.png" sizes="180x180">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Yardage Book">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
:root{
  --accent:#2d6a4f;
  --bg:#f5f6f7;
  --card:rgba(255,255,255,0.85);
  --border:rgba(0,0,0,0.06);
  --text:#1d1d1f;
  --muted:#6e6e73;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:1rem;
  padding-bottom:7rem;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Helvetica Neue",Helvetica,Arial,sans-serif;
  color:var(--text);
}

h1{
  text-align:center;
  font-size:1.6rem;
  font-weight:700;
  margin:.5rem 0 .25rem;
}

.card{
  background:var(--card);
  backdrop-filter:blur(14px);
  border:1px solid var(--border);
  border-radius:16px;
  padding:1rem;
  margin:.75rem auto;
  max-width:420px;
  box-shadow:0 1px 2px rgba(0,0,0,.04),0 10px 30px rgba(0,0,0,.08);
}

#yardageStatusTop{
  text-align:center;
  font-weight:700;
  color:var(--muted);
  margin:.25rem auto .5rem;
}

#map{
  height:320px;
  border-radius:18px;
  border:1px solid var(--border);
  overflow:hidden;
  margin:1rem auto;
  max-width:420px;
}

select,button{
  width:100%;
  padding:.75rem 1rem;
  border-radius:14px;
  font-size:1rem;
  font-weight:600;
  border:1px solid var(--border);
  background:white;
}

button{
  background:var(--accent);
  color:white;
  border:none;
  box-shadow:0 6px 16px rgba(45,106,79,.35);
  margin-top:.5rem;
}

button.secondary{
  background:white;
  color:var(--accent);
  box-shadow:none;
}

button:active{transform:scale(.97)}

#distanceDisplay{
  text-align:center;
  font-size:1.3rem;
  font-weight:700;
  margin-top:.5rem;
}

#clubSuggestion{
  text-align:center;
  margin-top:.4rem;
  font-weight:700;
  color:var(--accent);
}

#holeInfo{
  text-align:center;
  font-size:.95rem;
  color:var(--muted);
}

/* Weather */
#weatherBox{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:.75rem;
}

#weatherBox img{
  width:54px;
  height:54px;
}

/* Compass */
#compass{
  position:fixed;
  bottom:95px;
  right:18px;
  width:64px;
  height:64px;
  border-radius:50%;
  background:rgba(255,255,255,.9);
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:var(--accent);
  box-shadow:0 10px 30px rgba(0,0,0,.15);
}

/* Footer */
.footerBar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(14px);
  border-top:1px solid var(--border);
  padding:.75rem 1rem;
}

.footerInner{ max-width:420px; margin:auto; }

.footerRow{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:.5rem;
}

.footerText{
  font-size:.75rem;
  color:var(--muted);
  text-align:center;
  margin-top:.5rem;
}

.footerActions{
  display:flex;
  gap:.4rem;
}

.footerActions button{
  width:auto;
  padding:.5rem .75rem;
  border-radius:999px;
  font-size:.85rem;
  margin-top:0;
}

.footerHint{
  font-size:.75rem;
  color:var(--muted);
  margin-top:.4rem;
}

.footerHint a{
  color:var(--accent);
  font-weight:700;
  text-decoration:none;
}

#adminBadge{
  display:none;
  font-size:.75rem;
  font-weight:700;
  color:var(--accent);
}
</style>
</head>

<body>

<h1>Yardage Book</h1>
<div id="yardageStatusTop">Club Yardages: Not loaded</div>

<div id="weatherBox" class="card">Loading weather‚Ä¶</div>

<div id="map"></div>

<div class="card">
  <select id="holeSelect" onchange="showHoleLayout()">
    <option value="">Select Hole</option>
    <option value="1">Hole 1</option>
    <option value="2">Hole 2</option>
    <option value="3">Hole 3</option>
    <option value="4">Hole 4</option>
    <option value="5">Hole 5</option>
    <option value="6">Hole 6</option>
    <option value="7">Hole 7</option>
    <option value="8">Hole 8</option>
    <option value="9">Hole 9</option>
    <option value="Practice">Practice Area</option>
  </select>

  <div id="holeInfo">Select a hole to view details</div>
  <div id="distanceDisplay">Distance: --</div>
  <div id="clubSuggestion">Suggested Club: --</div>

  <button class="secondary" onclick="openYardageSheet()">üìä View Yardages</button>
</div>

<div id="saveButtons" class="card" style="display:none">
  <button>üìç Save Green Center</button>
  <button>‚ö™ Save White Tee</button>
  <button>üü° Save Yellow Tee</button>
  <button class="secondary">üì§ Export Yardage Data</button>
</div>

<button onclick="enableCompass()">üß≠ Enable Compass</button>
<div id="compass">--</div>

<input type="file" id="yardageFile" accept=".json" style="display:none">

<!-- Footer -->
<div class="footerBar">
  <div class="footerInner">
    <div class="footerRow">
        <div class="footerActions">
      <span id="adminBadge">Admin</span>
      <button class="secondary"
        title="Add YardageBook.json"
        onclick="document.getElementById('yardageFile').click()">‚ûï</button>

<button class="secondary"
        title="Clear stored club yardages"
        onclick="clearYardageBook()">üóëÔ∏è</button>

<button class="secondary"
        title="Admin tools"
        onclick="toggleAdminMode()">üîí</button>
      </div>
    </div>
    <div class="footerHint">
      ForeThought export ‚Ä¢ Create one at
      <a href="http://forethought.site/yardagebook.html" target="_blank">forethought.site/yardagebook.html</a>
    </div>
    <br/>
  <div class="footerText">Powered by <a href="http://forethought.site" target="_blank">ForeThought.site</a>  ‚Ä¢ An Apple Geek Product</div>
  </div>
</div>

<!-- Yardage Sheet -->
<div id="yardageSheet" style="
  position:fixed; inset:0; display:none;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(6px);
  align-items:flex-end; justify-content:center;
  z-index:2000;">
  <div style="
    background:rgba(255,255,255,.96);
    border-radius:20px 20px 0 0;
    width:100%; max-width:420px;
    padding:1rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;">
      <strong>Yardages</strong>
      <button class="secondary" onclick="closeYardageSheet()">Done</button>
    </div>
    <div id="yardageList" style="max-height:55vh;overflow-y:auto"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const adminPasscode="2024";
let yardageBook=null;

/* Status */
function setStatus(t,ok){
  const el=document.getElementById("yardageStatusTop");
  el.textContent=t;
  el.style.color=ok?"var(--accent)":"var(--muted)";
}

/* Storage */
function validateBook(j){
  return j?.type==="yardageBook" && j?.source==="ForeThought" &&
    Array.isArray(j.clubs) && j.clubs.every(c=>typeof c.name==="string" && typeof c.carry==="number");
}

(function loadBook(){
  try{
    const raw=localStorage.getItem("yardageBookJSON");
    if(!raw) return setStatus("YardageBook: Not loaded",false);
    const j=JSON.parse(raw);
    if(!validateBook(j)) throw 0;
    yardageBook=j;
    setStatus("YardageBook: Loaded ‚úÖ",true);
  }catch{
    localStorage.removeItem("yardageBookJSON");
    setStatus("YardageBook: Not loaded",false);
  }
})();

document.getElementById("yardageFile").onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const j=JSON.parse(r.result);
    if(!validateBook(j)) return alert("Invalid ForeThought YardageBook");
    yardageBook=j;
    localStorage.setItem("yardageBookJSON",JSON.stringify(j));
    setStatus("YardageBook: Loaded ‚úÖ",true);
    showHoleLayout();
  };
  r.readAsText(f);
};

function clearYardageBook(){
  if(!confirm("Clear stored YardageBook?")) return;
  localStorage.removeItem("yardageBookJSON");
  yardageBook=null;
  setStatus("YardageBook: Not loaded",false);
  document.getElementById("clubSuggestion").innerText="Suggested Club: --";
}

/* Club logic */
function suggestClub(y){
  if(!yardageBook) return null;
  let best=null, diff=Infinity;
  yardageBook.clubs.forEach(c=>{
    const d=Math.abs(c.carry-y);
    if(d<=10 && d<diff){best=c;diff=d;}
  });
  return best;
}

/* Yardage sheet */
function openYardageSheet(){
  if(!yardageBook) return alert("No YardageBook loaded");
  const list=document.getElementById("yardageList");
  list.innerHTML="";
  const m=document.getElementById("distanceDisplay").innerText.match(/(\d+)/);
  const y=m?parseInt(m[1]):null;
  const s=y?suggestClub(y):null;

  yardageBook.clubs.forEach(c=>{
    const hl=s && s.name===c.name;
    list.innerHTML+=`
      <div style="display:flex;justify-content:space-between;padding:.6rem 0;
                  border-bottom:1px solid #eee;font-weight:${hl?"800":"600"};
                  color:${hl?"var(--accent)":"inherit"}">
        <div>${c.name}</div>
        <div style="font-size:.9rem;color:${hl?"var(--accent)":"var(--muted)"}">
          ${c.carry}y ‚Ä¢ ${c.total??""}
        </div>
      </div>`;
  });
  document.getElementById("yardageSheet").style.display="flex";
}
function closeYardageSheet(){document.getElementById("yardageSheet").style.display="none";}

/* Map + distance */
const greens={
  "1":[53.385712,-2.205569],"2":[53.385069,-2.206453],"3":[53.383919,-2.204562],
  "4":[53.387625,-2.202824],"5":[53.387667,-2.203872],"6":[53.384237,-2.203861],
  "7":[53.385387,-2.205308],"8":[53.387473,-2.20485],"9":[53.387958,-2.206264]
};

let map=L.map("map").setView([53.387,-2.205],17);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
let userMarker=null;

navigator.geolocation.watchPosition(p=>{
  const {latitude,longitude}=p.coords;
  userMarker?userMarker.setLatLng([latitude,longitude]):
    userMarker=L.marker([latitude,longitude]).addTo(map);
  showHoleLayout();
});

function showHoleLayout(){
  const h=holeSelect.value;
  if(!h||!greens[h]||!userMarker) return;
  const g={lat:greens[h][0],lng:greens[h][1]};
  const d=getDistance(userMarker.getLatLng(),g);
  const y=Math.round(d*1.09361);
  distanceDisplay.innerText=`Distance: ${y} yards`;
  const c=suggestClub(y);
  clubSuggestion.innerText=c?`Suggested Club: ${c.name} ‚Ä¢ ${c.carry}y carry`:"Suggested Club: --";
}

function getDistance(a,b){
  const R=6371e3,toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lng-a.lng);
  return R*2*Math.atan2(
    Math.sqrt(Math.sin(dLat/2)**2+
    Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2),
    Math.sqrt(1)
  );
}

/* Admin */
function toggleAdminMode(){
  if(prompt("Admin Passcode")==adminPasscode){
    saveButtons.style.display="block";
    adminBadge.style.display="inline";
  }
}

/* Weather */
async function loadWeather(){
  const r=await fetch("https://api.openweathermap.org/data/2.5/weather?lat=53.387&lon=-2.205&units=metric&appid=e583bd0c194bbfeb3deb92f6bfdad11a");
  const d=await r.json();
  const temp=Math.round(d.main.temp);
  const wind=Math.round(d.wind.speed*2.237);
  const dir=["N","NE","E","SE","S","SW","W","NW"][Math.round(d.wind.deg/45)%8];
  weatherBox.innerHTML=`
    <img src="https://openweathermap.org/img/wn/${d.weather[0].icon}@2x.png">
    <div><strong>Cheadle GC</strong><br>
    ${temp}¬∞C ‚Ä¢ ${d.weather[0].description}<br>
    Wind: ${wind} mph ${dir}</div>`;
}
loadWeather();

/* Compass */
function enableCompass(){
  window.addEventListener("deviceorientation",e=>{
    if(e.alpha!=null){
      const dirs=["N","NE","E","SE","S","SW","W","NW"];
      compass.innerText=dirs[Math.round(e.alpha/45)%8];
      compass.style.transform=`rotate(${-e.alpha}deg)`;
    }
  });
}
</script>

</body>
</html>
